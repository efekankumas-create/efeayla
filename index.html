<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blackjack Royale</title>

<style>
:root{--gold:#ffd700;--wood:#3d2b1f}
body{
  margin:0;background:#121212;color:white;
  font-family:Segoe UI,sans-serif;
  display:flex;justify-content:center;align-items:center;
  height:100vh
}
#lobby{
  background:#1e1e1e;padding:35px;border-radius:20px;
  border:3px solid var(--gold);text-align:center;width:340px
}
input,button{
  padding:12px;margin:8px;border-radius:10px;
  border:none;width:80%;font-size:1rem
}
input{background:#222;color:white}
button{background:var(--gold);font-weight:bold;cursor:pointer}

#game{
  display:none;width:95vw;height:90vh;
  background:radial-gradient(circle,#2e7d32,#0d2b0d);
  border:15px solid var(--wood);
  border-radius:120px;
  flex-direction:column;justify-content:space-around;align-items:center
}
.hand{display:flex;gap:-30px;min-height:120px}
.card{
  width:80px;height:115px;background:white;color:black;
  border-radius:8px;padding:5px;font-weight:bold;
  animation:deal .4s ease;
  box-shadow:4px 4px 10px #000
}
.red{color:#c62828}
@keyframes deal{
  from{transform:translateY(-80px);opacity:0}
  to{transform:none;opacity:1}
}
.zone{padding:15px;border-radius:20px;text-align:center}
.active{box-shadow:0 0 20px var(--gold)}
.controls{display:flex;gap:15px}
.status{
  background:rgba(0,0,0,.6);padding:10px 30px;
  border-radius:30px;color:var(--gold)
}
.timer{color:#ff5252;font-weight:bold}
</style>
</head>

<body>

<div id="lobby">
  <h2 style="color:var(--gold)">Blackjack Royale</h2>
  <input id="room" placeholder="Oda Kodu">
  <input id="name" placeholder="efe / ayla">
  <button onclick="join()">Odaya Gir</button>
</div>

<div id="game">
  <div class="status">
    <span id="status">Bekleniyor</span> | ‚è± <span id="timer">--</span>
  </div>

  <div class="zone">
    <b>Krupiye</b>
    <div id="dealerCards" class="hand"></div>
    <div id="dealerScore">?</div>
  </div>

  <div style="display:flex;width:100%;justify-content:space-around">
    <div id="p1" class="zone">
      <b id="p1Name"></b> | üí∞ <span id="p1Chips"></span>
      <div id="p1Cards" class="hand"></div>
      <div id="p1Score"></div>
    </div>
    <div id="p2" class="zone">
      <b id="p2Name"></b> | üí∞ <span id="p2Chips"></span>
      <div id="p2Cards" class="hand"></div>
      <div id="p2Score"></div>
    </div>
  </div>

  <div class="controls">
    <button onclick="hit()">Hit</button>
    <button onclick="stand()">Stand</button>
    <button onclick="newGame()">Yeni El (10)</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyC_H3M5q_bFPPSi4Xw3_hpgPrbdTpcmEHo",
  databaseURL:"https://blakja-a9592-default-rtdb.firebaseio.com"
});
const db=firebase.database();

let room="",me="",ref,timerInt,lastHands="";

function join(){
  room = document.getElementById("room").value.trim();
  me   = document.getElementById("name").value.trim().toLowerCase();

  if(!room || !["efe","ayla"].includes(me)){
    alert("Oda kodu ve isim doƒüru girilmeli (efe / ayla)");
    return;
  }

  document.getElementById("lobby").style.display = "none";
  document.getElementById("game").style.display  = "flex";

  ref = db.ref("rooms/" + room);

ref.once("value", s => {
  if(!s.exists() || me === "efe"){
    init(); // HER ≈ûEY SIFIRLANIR
  }
});

  ref.on("value", s => render(s.val()));
}

function init(){
  ref.set({
    turn:"efe",timer:15,over:true,status:"Yeni el",
    p1:{name:"efe",hand:[],chips:100},
    p2:{name:"ayla",hand:[],chips:100},
    dealer:[],deck:[]
  });
}

function newGame(){
  if(me!=="efe") return;

  const suits=["‚ô†","‚ô£","‚ô•","‚ô¶"];
  const vals=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  let deck=[];
  suits.forEach(s=>vals.forEach(v=>deck.push({s,v})));
  deck.sort(()=>Math.random()-0.5);

  ref.once("value",s=>{
    let d=s.val();
    if(d.p1.chips<10||d.p2.chips<10) return;

    d.p1.chips-=10;
    d.p2.chips-=10;

    d.deck=deck;
    d.dealer=[deck.pop(),deck.pop()];
    d.p1.hand=[deck.pop(),deck.pop()];
    d.p2.hand=[deck.pop(),deck.pop()];

    d.turn="efe";
    d.timer=15;
    d.over=false;
    d.status="Sƒ±ra: efe";

    ref.set(d);
    startTimer();
  });
}

function hit(){action("hit")}
function stand(){action("stand")}

function action(t){
  ref.once("value",s=>{
    let d=s.val();
    if(d.turn!==me||d.over) return;

    let p=me==="efe"?d.p1:d.p2;
    if(t==="hit") p.hand.push(d.deck.pop());

    if(t==="stand"||score(p.hand)>21){
      d.turn=me==="efe"?"ayla":"dealer";
      d.timer=15;
    }

    ref.set(d);
    if(d.turn==="dealer") dealer(d);
    else startTimer();
  });
}

function dealer(d){
  while(score(d.dealer)<17) d.dealer.push(d.deck.pop());

  d.over=true;
  let ds=score(d.dealer);

  ["p1","p2"].forEach(p=>{
    let ps=score(d[p].hand);
    if(ps<=21&&(ds>21||ps>ds)) d[p].chips+=20;
    else if(ps===ds) d[p].chips+=10;
  });

  d.status="El bitti";
  d.turn="efe";
  ref.set(d);
}

function startTimer(){
  clearInterval(timerInt);
  timerInt=setInterval(()=>{
    ref.once("value",s=>{
      let d=s.val();
      if(d.over){clearInterval(timerInt);return;}
      d.timer--;
      if(d.timer<=0){
        d.turn=d.turn==="efe"?"ayla":"dealer";
        d.timer=15;
        ref.set(d);
        if(d.turn==="dealer") dealer(d);
      }else ref.set(d);
    });
  },1000);
}

function score(h){
  let s=0,a=0;
  h.forEach(c=>{
    if(c.v==="A") a++;
    else if("JQK".includes(c.v)) s+=10;
    else s+=parseInt(c.v);
  });
  while(a--) s+=s+11>21?1:11;
  return s;
}

function render(d){
  if(!d) return;

  status.innerText=d.status;
  timer.innerText=d.timer;

  p1Name.innerText=d.p1.name;
  p2Name.innerText=d.p2.name;
  p1Chips.innerText=d.p1.chips;
  p2Chips.innerText=d.p2.chips;

  const state=JSON.stringify({p1:d.p1.hand,p2:d.p2.hand,dealer:d.dealer,over:d.over});
  if(state!==lastHands){
    lastHands=state;
    draw(p1Cards,d.p1.hand,me==="efe");
    draw(p2Cards,d.p2.hand,me==="ayla");
    draw(dealerCards,d.dealer,d.over);
    p1Score.innerText=score(d.p1.hand);
    p2Score.innerText=score(d.p2.hand);
    dealerScore.innerText=d.over?score(d.dealer):"?";
  }

  p1.classList.toggle("active",d.turn==="efe");
  p2.classList.toggle("active",d.turn==="ayla");
}

function draw(el,hand,show){
  el.innerHTML="";
  hand.forEach(c=>{
    const div=document.createElement("div");
    div.className="card "+("‚ô•‚ô¶".includes(c.s)?"red":"");
    if(!show) div.style.background="#1a237e";
    else div.innerHTML=`${c.v}<div style="font-size:2rem">${c.s}</div>${c.v}`;
    el.appendChild(div);
  });
}
</script>
</body>
</html>
